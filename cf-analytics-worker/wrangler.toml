# Cloudflare Worker for Analytics
# Handles: presence tracking, page views, watch sessions, live activity
name = "flyx-analytics"
main = "src/index.ts"
compatibility_date = "2025-12-07"

# Free tier: 100,000 requests/day
# With 30s heartbeats and ~100 concurrent users: ~288,000 req/day
# Consider Workers Paid ($5/mo) for high traffic

# Observability - DISABLED to reduce costs ($0.60/million events was costing ~$400/month!)
[observability]
enabled = false

[vars]
LOG_LEVEL = "info"
# ALLOWED_ORIGINS = "https://tv.vynx.cc,http://localhost:3000"
# Heartbeat interval in seconds (client should match this)
HEARTBEAT_INTERVAL = "60"

# =============================================================================
# DURABLE OBJECTS - Single instance for all analytics (solves distributed worker issue)
# =============================================================================
[durable_objects]
bindings = [
  { name = "ANALYTICS_DO", class_name = "AnalyticsDO" }
]

[[migrations]]
tag = "v1"
new_classes = ["AnalyticsDO"]

# =============================================================================
# D1 DATABASE - Create with: wrangler d1 create flyx-analytics-db
# =============================================================================
[[d1_databases]]
binding = "DB"
database_name = "flyx-analytics-db"
database_id = "a80ef8c6-3d7a-4847-baa7-b535af4e4402"

# =============================================================================
# KV NAMESPACE - For rate limiting and deduplication (optional)
# =============================================================================
# Create with: wrangler kv:namespace create "ANALYTICS_KV"
# [[kv_namespaces]]
# binding = "ANALYTICS_KV"
# id = "your-kv-namespace-id"

# Production environment
[env.production]
name = "flyx-analytics"

[env.production.vars]
LOG_LEVEL = "warn"
HEARTBEAT_INTERVAL = "60"

[env.production.observability]
enabled = false

[env.production.durable_objects]
bindings = [
  { name = "ANALYTICS_DO", class_name = "AnalyticsDO" }
]

# =============================================================================
# CRON TRIGGERS - Scheduled tasks
# =============================================================================
[triggers]
crons = ["0 0 * * *"]  # Daily at midnight UTC - aggregate daily metrics

# Development environment
[env.development]
name = "flyx-analytics-dev"

[env.development.vars]
LOG_LEVEL = "debug"
HEARTBEAT_INTERVAL = "10"

[env.development.observability]
enabled = false

[env.development.durable_objects]
bindings = [
  { name = "ANALYTICS_DO", class_name = "AnalyticsDO" }
]
