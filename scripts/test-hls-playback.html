<!DOCTYPE html>
<html>
<head>
  <title>VIPRow Stream Test</title>
  <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; background: #1a1a1a; color: #fff; }
    video { width: 100%; max-width: 800px; background: #000; }
    .info { margin: 20px 0; padding: 15px; background: #333; border-radius: 8px; }
    pre { background: #222; padding: 10px; overflow-x: auto; font-size: 12px; }
    button { padding: 10px 20px; margin: 5px; cursor: pointer; }
    .error { color: #ff6b6b; }
    .success { color: #69db7c; }
  </style>
</head>
<body>
  <h1>VIPRow Direct Stream Test</h1>
  
  <div class="info">
    <p>This page tests direct m3u8 playback from VIPRow/Casthill.</p>
    <p>Enter the m3u8 URL from the API response:</p>
    <input type="text" id="m3u8Url" style="width: 100%; padding: 10px; margin: 10px 0;" 
           placeholder="https://s-c7.peulleieo.net/pavel/...">
    <br>
    <button onclick="loadStream()">Load Stream</button>
    <button onclick="testWithProxy()">Test with Proxy Headers</button>
  </div>
  
  <video id="video" controls></video>
  
  <div class="info">
    <h3>Status</h3>
    <div id="status">Ready</div>
  </div>
  
  <div class="info">
    <h3>Debug Log</h3>
    <pre id="log"></pre>
  </div>

  <script>
    const video = document.getElementById('video');
    const statusEl = document.getElementById('status');
    const logEl = document.getElementById('log');
    
    function log(msg, isError = false) {
      const time = new Date().toLocaleTimeString();
      const line = `[${time}] ${msg}\n`;
      logEl.textContent += line;
      logEl.scrollTop = logEl.scrollHeight;
      console.log(msg);
    }
    
    function setStatus(msg, isError = false) {
      statusEl.innerHTML = `<span class="${isError ? 'error' : 'success'}">${msg}</span>`;
    }
    
    function loadStream() {
      const url = document.getElementById('m3u8Url').value.trim();
      if (!url) {
        setStatus('Please enter a m3u8 URL', true);
        return;
      }
      
      log('Loading stream: ' + url);
      
      if (Hls.isSupported()) {
        const hls = new Hls({
          debug: true,
          xhrSetup: function(xhr, url) {
            // Note: These headers may be blocked by CORS in browser
            // The stream server needs to allow these origins
            log('Fetching: ' + url.substring(0, 80) + '...');
          }
        });
        
        hls.on(Hls.Events.MANIFEST_PARSED, function() {
          log('Manifest parsed successfully');
          setStatus('Manifest loaded - attempting playback...');
          video.play().catch(e => log('Autoplay blocked: ' + e.message));
        });
        
        hls.on(Hls.Events.ERROR, function(event, data) {
          log('HLS Error: ' + data.type + ' - ' + data.details, true);
          if (data.fatal) {
            setStatus('Fatal error: ' + data.details, true);
            switch(data.type) {
              case Hls.ErrorTypes.NETWORK_ERROR:
                log('Network error - likely CORS issue');
                break;
              case Hls.ErrorTypes.MEDIA_ERROR:
                log('Media error - trying to recover');
                hls.recoverMediaError();
                break;
              default:
                hls.destroy();
                break;
            }
          }
        });
        
        hls.on(Hls.Events.FRAG_LOADED, function(event, data) {
          log('Fragment loaded: ' + data.frag.sn);
        });
        
        hls.on(Hls.Events.KEY_LOADED, function(event, data) {
          log('Decryption key loaded');
          setStatus('Key loaded - stream should play');
        });
        
        hls.loadSource(url);
        hls.attachMedia(video);
        
      } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
        // Native HLS support (Safari)
        video.src = url;
        video.addEventListener('loadedmetadata', function() {
          log('Native HLS: metadata loaded');
          video.play();
        });
      } else {
        setStatus('HLS not supported in this browser', true);
      }
    }
    
    function testWithProxy() {
      // For testing, you'd need a proxy that adds the required headers
      // This is just a placeholder
      alert('To test with proxy headers, you need to set up a server-side proxy that adds:\n\n' +
            'Origin: https://casthill.net\n' +
            'Referer: https://casthill.net/\n\n' +
            'The browser cannot add these headers due to CORS restrictions.');
    }
  </script>
</body>
</html>
